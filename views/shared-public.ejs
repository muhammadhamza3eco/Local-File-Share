<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Public Files</title>
    <link rel="stylesheet" href="/style.css">
    <!-- Add Roboto font (already included) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <!-- Add Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- Removed Font Awesome -->
</head>
<body>
    <!-- Menu Toggle Button for Mobile -->
    <button class="menu-toggle" id="menuToggleBtn" aria-label="Toggle menu">
        <span class="material-icons">menu</span>
    </button>
    <%- include('partials/sidebar', { currentPage: 'shared-public' }) %>
    
    <div class="main-content">
        <div class="header-bar">
            <h2><span class="material-icons">share</span> Publicly Shared Items</h2> <!-- Changed title -->
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Search items..." onkeyup="filterItems()"> <!-- Changed placeholder and function name -->
        </div>
        
        <ul class="file-list" id="itemList"> <!-- Changed id -->
            <% if (items.length > 0) { %> <!-- Changed variable name -->
                <% items.forEach(item => { %> <!-- Changed variable name -->
                    <li>
                        <% if (item.isDirectory) { %>
                            <!-- Display Folder -->
                            <div class="file-info-group">
                                <span class="material-icons icon-folder">folder_shared</span> <!-- Folder icon -->
                                <span class="file-name"><%= item.name %></span>
                                <!-- Size not applicable for folders -->
                            </div>
                            <span class="item-details">
                                <span class="file-owner"><span class="material-icons">person</span> Shared by: <strong><%= item.owner %></strong></span>
                                <span class="modified-date" title="<%= item.mtime.toISOString() %>"><%= item.mtime.toLocaleString() %></span>
                                <!-- No direct download for folders -->
                            </span>
                        <% } else { %>
                            <!-- Display File -->
                            <div class="file-info-group">
                                <span class="material-icons icon-file">description</span>
                                <span class="file-name"><%= item.name %></span>
                                <span class="file-size">(<%= formatFileSize(item.size) %>)</span>
                            </div>
                            <span class="item-details">
                                <span class="file-owner"><span class="material-icons">person</span> Shared by: <strong><%= item.owner %></strong></span>
                                <span class="modified-date" title="<%= item.mtime.toISOString() %>"><%= item.mtime.toLocaleString() %></span>
                                <a href="/public/<%= item.owner %>/<%= item.path %>" class="download-link icon-button" title="Download"><span class="material-icons">download</span></a>
                            </span>
                        <% } %>
                    </li>
                <% }); %>
            <% } else { %>
                <li class="empty-dir"><em>No shared items available.</em></li> <!-- Changed text -->
            <% } %>
        </ul>
        
        <!-- Pagination Controls -->
        <% if (pagination && pagination.totalPages > 1) { %>
            <div class="pagination-info">
                Showing <%= (pagination.currentPage - 1) * pagination.itemsPerPage + 1 %> to
                <%= Math.min(pagination.currentPage * pagination.itemsPerPage, pagination.totalItems) %>
                of <%= pagination.totalItems %> items
            </div>
            <div class="pagination">
                <% if (pagination.hasPrevPage) { %>
                    <div class="page-item">
                        <a class="page-link" href="/shared-public?page=1">
                            <span class="material-icons">first_page</span>
                        </a>
                    </div>
                    <div class="page-item">
                        <a class="page-link" href="/shared-public?page=<%= pagination.currentPage - 1 %>">
                            <span class="material-icons">chevron_left</span>
                        </a>
                    </div>
                <% } else { %>
                    <div class="page-item disabled">
                        <span class="page-link"><span class="material-icons">first_page</span></span>
                    </div>
                    <div class="page-item disabled">
                        <span class="page-link"><span class="material-icons">chevron_left</span></span>
                    </div>
                <% } %>

                <%
                let startPage = Math.max(1, pagination.currentPage - 2);
                let endPage = Math.min(pagination.totalPages, startPage + 4);
                
                if (endPage - startPage < 4 && pagination.totalPages > 4) {
                    startPage = Math.max(1, endPage - 4);
                }
                
                for (let i = startPage; i <= endPage; i++) { %>
                    <div class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                        <a class="page-link" href="/shared-public?page=<%= i %>"><%= i %></a>
                    </div>
                <% } %>

                <% if (pagination.hasNextPage) { %>
                    <div class="page-item">
                        <a class="page-link" href="/shared-public?page=<%= pagination.currentPage + 1 %>">
                            <span class="material-icons">chevron_right</span>
                        </a>
                    </div>
                    <div class="page-item">
                        <a class="page-link" href="/shared-public?page=<%= pagination.totalPages %>">
                            <span class="material-icons">last_page</span>
                        </a>
                    </div>
                <% } else { %>
                    <div class="page-item disabled">
                        <span class="page-link"><span class="material-icons">chevron_right</span></span>
                    </div>
                    <div class="page-item disabled">
                        <span class="page-link"><span class="material-icons">last_page</span></span>
                    </div>
                <% } %>
            </div>
        <% } %>
    </div>
    
    <script>
        function filterItems() { // Renamed function
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const itemList = document.getElementById('itemList'); // Changed id
            const listElements = itemList.getElementsByTagName('li'); // Changed variable name
            
            let hasVisibleItems = false;
            
            for (let i = 0; i < listElements.length; i++) { // Changed variable name
                const li = listElements[i]; // Changed variable name
                // Ensure we don't try to filter the 'empty' message if it exists
                if (li.classList.contains('empty-dir')) {
                    li.style.display = "none"; // Hide empty message during filtering
                    continue;
                }
                const text = li.textContent || li.innerText;
                
                if (text.toLowerCase().indexOf(filter) > -1) {
                    li.style.display = "";
                    hasVisibleItems = true;
                } else {
                    li.style.display = "none";
                }
            }
            
            // Show message if no items match the filter
            const noMatch = document.getElementById('noMatchMessage');
            if (!hasVisibleItems && listElements.length > 0) {
                if (!noMatch) { // Create message only if it doesn't exist
                    const newNoMatch = document.createElement('li');
                    newNoMatch.id = 'noMatchMessage';
                    newNoMatch.className = 'empty-dir';
                    newNoMatch.innerHTML = '<em>No matching items found.</em>'; // Changed text
                    itemList.appendChild(newNoMatch);
                } else {
                    noMatch.style.display = ""; // Show existing message
                }
            } else if (noMatch) {
                noMatch.style.display = "none"; // Hide message if items are found
            }

            // If the list was initially empty, ensure the original empty message is hidden
            const originalEmpty = itemList.querySelector('.empty-dir:not(#noMatchMessage)');
            if (originalEmpty && filter) {
                originalEmpty.style.display = 'none';
            } else if (originalEmpty && !filter && listElements.length === 1 && listElements[0] === originalEmpty) {
                // Show original empty message if filter is cleared and list was initially empty
                originalEmpty.style.display = '';
            }

        }

        // Initial call in case the page loads with search params (though not implemented here)
        // filterItems(); // Uncomment if you add server-side search query persistence for this page
    </script>
    <script src="/script.js"></script> <!-- Add main script include -->
</body>
</html>